<% content_for :title do %>
  <%= @definition.title %>
<% end %>

<section class="assessment" data-controller="assessment" data-assessment-total-value="<%= @definition.questions.size %>" data-assessment-show-start-screen-value="<%= @definition.show_start_screen %>">
  <% if @definition.show_start_screen %>
    <div class="assessment-start-screen is-active" data-assessment-target="startScreen">
      <header class="assessment-start-header">
        <% if @definition.hook.present? %>
          <p class="assessment-eyebrow"><%= @definition.hook %></p>
        <% end %>
        <h1 class="assessment-title"><%= @definition.title %></h1>
      </header>

      <% if @definition.description.present? %>
        <p class="assessment-start-description"><%= @definition.description %></p>
      <% end %>

      <button type="button"
              class="btn btn-primary btn-start"
              data-action="assessment#start">
        <%= t('rails.assessment.start.button') %>
      </button>

      <% if @definition.estimated_time.present? || @definition.show_question_count %>
        <div class="assessment-start-meta">
          <% if @definition.estimated_time.present? %>
            <span class="assessment-start-meta-item"><%= @definition.estimated_time %></span>
          <% end %>
          <% if @definition.show_question_count %>
            <span class="assessment-start-meta-item"><%= @definition.questions.size %> <%= t('rails.assessment.start.question', count: @definition.questions.size) %></span>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>

  <div class="assessment-content" data-assessment-target="content">
    <header class="assessment-header">
      <p class="assessment-eyebrow"><%= @definition.hook %></p>
      <h1 class="assessment-title"><%= @definition.title %></h1>
    </header>

  <%= form_with url: assessment_response_path(@definition.slug), method: :post, class: "assessment-form", local: true do |form| %>
    <div class="assessment-progress">
      <div class="assessment-progress-bar" data-assessment-target="progress"></div>
    </div>

    <div class="assessment-steps" data-assessment-target="steps">
      <% @definition.questions.each_with_index do |question, index| %>
        <turbo-frame id="question_<%= question.id %>"
                     class="assessment-step <%= 'is-active' if index.zero? %>"
                     data-assessment-target="step"
                     data-step-index="<%= index %>"
                     data-required="<%= question.required? %>"
                     data-multi="<%= question.allow_multiple? %>">
          <div class="assessment-question">
            <p class="question-text"><%= question.text %></p>
            <% if question.help_text.present? %>
              <p class="question-help"><%= question.help_text %></p>
            <% end %>

            <div class="question-options" role="group">
              <% question.options.each do |option| %>
                <% input_name = question.allow_multiple? ? "response[#{question.id}][]" : "response[#{question.id}]" %>
                <% input_type = question.allow_multiple? ? "checkbox" : "radio" %>
                <label class="question-option">
                  <input type="<%= input_type %>"
                         name="<%= input_name %>"
                         value="<%= option.id.presence || option.tag || option.value %>"
                         data-action="change->assessment#markAnswered"
                         <%= 'required' if question.required? && !question.allow_multiple? %> />
                  <span class="option-label"><%= option.text %></span>
                </label>
              <% end %>
            </div>
          </div>
        </turbo-frame>
      <% end %>

      <% if @definition.capture_name || @definition.capture_email %>
        <div class="assessment-step assessment-lead-capture"
             data-assessment-target="step"
             data-step-index="<%= @definition.questions.size %>"
             data-required="true"
             data-lead-capture="true">
          <div class="assessment-question">
            <p class="question-text"><%= t('rails.assessment.form.almost_done') %></p>

            <div class="lead-capture-fields">
              <% if @definition.capture_name %>
                <div class="lead-capture-field">
                  <label for="lead_name" class="lead-capture-label"><%= t('rails.assessment.form.name_label') %></label>
                  <input type="text"
                         id="lead_name"
                         name="lead[name]"
                         class="lead-capture-input"
                         placeholder="Max Mustermann"
                         required
                         data-action="input->assessment#markAnswered" />
                </div>
              <% end %>

              <% if @definition.capture_email %>
                <div class="lead-capture-field">
                  <label for="lead_email" class="lead-capture-label"><%= t('rails.assessment.form.email_label') %></label>
                  <input type="email"
                         id="lead_email"
                         name="lead[email]"
                         class="lead-capture-input"
                         placeholder="max@beispiel.de"
                         required
                         data-action="input->assessment#markAnswered" />
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <div class="assessment-navigation">
      <button type="button"
              class="btn btn-secondary"
              data-action="assessment#previous"
              data-assessment-target="backButton">
        <%= t('rails.assessment.navigation.back') %>
      </button>

      <button type="button"
              class="btn btn-primary"
              data-action="assessment#next"
              data-assessment-target="nextButton">
        <%= t('rails.assessment.navigation.next') %>
      </button>

      <%= form.submit t('rails.assessment.navigation.submit'),
                      class: "btn btn-submit",
                      data: { assessment_target: "submitButton", action: "assessment#submit" } %>
    </div>
  <% end %>
  </div>
</section>
