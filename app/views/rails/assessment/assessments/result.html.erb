<% content_for :title do %>
  <%= @definition.title %> – <%= t('rails.assessment.result.page_title') %>
<% end %>

<% headline = result_payload(@result_rule, :headline, nil) %>
<% summary = result_payload(@result_rule, :summary, nil) %>
<% insights = result_payload(@result_rule, :insights, []) %>
<% educational_content = result_payload(@result_rule, :educational_content, []) %>
<% score_message = result_payload(@result_rule, :score_message, nil) %>
<% cta_text = result_payload(@result_rule, :cta_text, t('rails.assessment.result.restart_button')) %>
<% cta_url = @cta_url || assessment_path(@definition.slug) %>

<section class="assessment-result">
  <header class="result-header">
    <% if user_name(@response).present? %>
      <p class="result-greeting"><%= t('rails.assessment.result.greeting', name: user_name(@response)) %></p>
    <% end %>
    <h1 class="result-title"><%= headline.presence || t('rails.assessment.result.default_headline') %></h1>
    <p class="result-subtitle"><%= @definition.title %></p>
    <% if user_name(@response).present? %>
      <p class="result-personal-note"><%= t('rails.assessment.result.personal_note_html', name: user_name(@response)).html_safe %></p>
    <% end %>
  </header>

  <% if @response&.score.to_i > 0 %>
    <div class="result-score-section">
      <div class="result-score-circle">
        <svg class="result-score-svg" viewBox="0 0 120 120">
          <circle class="result-score-bg" cx="60" cy="60" r="54"></circle>
          <circle class="result-score-fill"
                  cx="60"
                  cy="60"
                  r="54"
                  style="--score-percentage: <%= score_percentage(@response.score, 100) %>"></circle>
        </svg>
        <div class="result-score-text">
          <div class="result-score-value"><%= score_percentage(@response.score, 100) %>%</div>
          <div class="result-score-label"><%= t('rails.assessment.result.score_label') %></div>
        </div>
      </div>
      <% if score_message.present? %>
        <p class="result-score-message"><%= score_message %></p>
      <% end %>
    </div>
  <% end %>

  <article class="result-body">
    <% if summary.present? %>
      <div class="result-section result-summary">
        <p class="result-text"><%= summary %></p>
      </div>
    <% else %>
      <div class="result-section">
        <p class="result-text"><%= (@result_rule&.text || @response.result).to_s %></p>
      </div>
    <% end %>

    <% if insights.any? %>
      <div class="result-section result-insights-section">
        <h2 class="result-section-title"><%= t('rails.assessment.result.insights_title') %></h2>
        <div class="result-insights">
          <% insights.each do |insight| %>
            <div class="result-insight-item">
              <span class="result-insight-icon">✓</span>
              <span class="result-insight-text"><%= insight %></span>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <% if educational_content.any? %>
      <div class="result-section result-educational-section">
        <h2 class="result-section-title"><%= t('rails.assessment.result.recommendations_title') %></h2>
        <ul class="result-educational-list">
          <% educational_content.each do |content| %>
            <li class="result-educational-item"><%= content %></li>
          <% end %>
        </ul>
      </div>
    <% end %>
  </article>

  <footer class="result-footer">
    <%= link_to cta_text, cta_url, class: "btn btn-primary btn-large" %>
    <% if user_email(@response).present? && @definition.notification_email.present? %>
      <p class="result-footer-note"><%= t('rails.assessment.result.email_sent', email: user_email(@response)) %></p>
    <% end %>
  </footer>
</section>
